<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECO Market - Administraci√≥n</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary-color: #2ecc71;
            --primary-dark: #27ae60;
            --secondary-color: #3498db;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --success-color: #2ecc71;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 15px 0;
            margin-bottom: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 30px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo img {
            height: 50px;
            width: auto;
        }

        .logo-text {
            font-size: 24px;
            font-weight: 700;
        }

        .logo-text span {
            color: var(--light-color);
            font-weight: 300;
        }

        .tabs {
            display: flex;
            margin-bottom: 25px;
            background-color: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            flex: 1;
            text-align: center;
            transition: var(--transition);
            position: relative;
            font-weight: 500;
            color: var(--dark-color);
        }

        .tab:hover {
            background-color: rgba(46, 204, 113, 0.1);
            color: var(--primary-dark);
        }

        .tab.active {
            background-color: var(--primary-color);
            color: white;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid var(--primary-color);
        }

        .tab-content {
            display: none;
            background-color: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tab-content.active {
            display: block;
        }

        h2 {
            color: var(--dark-color);
            margin-bottom: 20px;
            font-size: 22px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            display: inline-block;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 25px;
            box-shadow: 0 2px 3px rgba(0,0,0,0.1);
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 500;
            text-transform: uppercase;
            font-size: 14px;
            letter-spacing: 0.5px;
        }

        tr:hover {
            background-color: rgba(46, 204, 113, 0.05);
        }

        form {
            margin-bottom: 30px;
            background-color: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark-color);
        }

        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-family: 'Poppins', sans-serif;
            transition: var(--transition);
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.2);
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--box-shadow);
        }

        button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        button.secondary {
            background-color: var(--secondary-color);
        }

        button.danger {
            background-color: var(--danger-color);
        }

        button.warning {
            background-color: var(--warning-color);
        }

        .message {
            padding: 15px;
            margin-bottom: 25px;
            border-radius: var(--border-radius);
            display: none;
            animation: fadeIn 0.5s ease;
            box-shadow: var(--box-shadow);
        }

        .success {
            background-color: rgba(46, 204, 113, 0.2);
            color: var(--dark-color);
            border-left: 4px solid var(--success-color);
        }

        .error {
            background-color: rgba(231, 76, 60, 0.2);
            color: var(--dark-color);
            border-left: 4px solid var(--danger-color);
        }

        .card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            text-align: center;
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card i {
            font-size: 30px;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .stat-card h3 {
            font-size: 14px;
            color: #7f8c8d;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .stat-card p {
            font-size: 28px;
            font-weight: 700;
            color: var(--dark-color);
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab.active::after {
                display: none;
            }
            
            .stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <!-- Logo en formato SVG directamente en el HTML -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="50" height="50" fill="white">
                    <path d="M12 2L4 7v10l8 5 8-5V7L12 2zm0 2.5L18 8v8l-6 3.5-6-3.5V8l6-3.5z"/>
                    <path d="M12 12l-6-3.5v7l6 3.5 6-3.5v-7L12 12zm0 2.5l3.5-2v3L12 18l-3.5-2v-3l3.5 2z"/>
                </svg>
                <div class="logo-text">ECO<span>Market</span></div>
            </div>
            <div class="header-actions">
                <button class="secondary"><i class="fas fa-sync-alt"></i> Actualizar</button>
            </div>
        </header>

        <div class="stats">
            <div class="stat-card">
                <i class="fas fa-box-open"></i>
                <h3>Productos</h3>
                <p id="productos-count">0</p>
            </div>
            <div class="stat-card">
                <i class="fas fa-users"></i>
                <h3>Clientes</h3>
                <p id="clientes-count">0</p>
            </div>
            <div class="stat-card">
                <i class="fas fa-shopping-cart"></i>
                <h3>Compras</h3>
                <p id="compras-count">0</p>
            </div>
            <div class="stat-card">
                <i class="fas fa-list-alt"></i>
                <h3>Detalles</h3>
                <p id="detalles-count">0</p>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="openTab('productos')"><i class="fas fa-box-open"></i> Productos</div>
            <div class="tab" onclick="openTab('clientes')"><i class="fas fa-users"></i> Clientes</div>
            <div class="tab" onclick="openTab('compras')"><i class="fas fa-shopping-cart"></i> Compras</div>
            <div class="tab" onclick="openTab('detalles')"><i class="fas fa-list-alt"></i> Detalles</div>
        </div>

        <div id="message" class="message"></div>

        <!-- Tabla de Productos -->
        <div id="productos" class="tab-content active">
            <h2><i class="fas fa-box-open"></i> Gesti√≥n de Productos</h2>
            <form id="productoForm">
                <input type="hidden" id="productoId">
                <div class="form-row">
                    <div class="form-group">
                        <label for="nombreProducto"><i class="fas fa-tag"></i> Nombre del Producto</label>
                        <input type="text" id="nombreProducto" placeholder="Ej: Arroz Integral" required>
                    </div>
                    <div class="form-group">
                        <label for="stock"><i class="fas fa-boxes"></i> Stock Disponible</label>
                        <input type="number" id="stock" placeholder="Ej: 100" required>
                    </div>
                </div>
                <div class="actions">
                    <button type="button" onclick="guardarProducto()"><i class="fas fa-save"></i> Guardar</button>
                    <button type="button" class="warning" onclick="limpiarFormulario('productoForm')"><i class="fas fa-broom"></i> Limpiar</button>
                </div>
            </form>
            <div class="card">
                <table id="productosTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nombre</th>
                            <th>Stock</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Tabla de Clientes -->
        <div id="clientes" class="tab-content">
            <h2><i class="fas fa-users"></i> Gesti√≥n de Clientes</h2>
            <form id="clienteForm">
                <input type="hidden" id="clienteRun">
                <div class="form-row">
                    <div class="form-group">
                        <label for="run"><i class="fas fa-id-card"></i> RUN</label>
                        <input type="text" id="run" placeholder="Ej: 12345678" required>
                    </div>
                    <div class="form-group">
                        <label for="dv"><i class="fas fa-hashtag"></i> D√≠gito Verificador</label>
                        <input type="text" id="dv" maxlength="1" placeholder="Ej: K" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="nombres"><i class="fas fa-user"></i> Nombres</label>
                        <input type="text" id="nombres" placeholder="Ej: Juan Carlos" required>
                    </div>
                    <div class="form-group">
                        <label for="apellidos"><i class="fas fa-user"></i> Apellidos</label>
                        <input type="text" id="apellidos" placeholder="Ej: P√©rez Gonz√°lez" required>
                    </div>
                </div>
                <div class="actions">
                    <button type="button" onclick="guardarCliente()"><i class="fas fa-save"></i> Guardar</button>
                    <button type="button" class="warning" onclick="limpiarFormulario('clienteForm')"><i class="fas fa-broom"></i> Limpiar</button>
                </div>
            </form>
            <div class="card">
                <table id="clientesTable">
                    <thead>
                        <tr>
                            <th>RUN</th>
                            <th>DV</th>
                            <th>Nombres</th>
                            <th>Apellidos</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Tabla de Compras -->
        <div id="compras" class="tab-content">
            <h2><i class="fas fa-shopping-cart"></i> Gesti√≥n de Compras</h2>
            <form id="compraForm">
                <input type="hidden" id="compraId">
                <div class="form-row">
                    <div class="form-group">
                        <label for="fechaCompra"><i class="fas fa-calendar-alt"></i> Fecha de Compra</label>
                        <input type="date" id="fechaCompra" required>
                    </div>
                    <div class="form-group">
                        <label for="numeroFactura"><i class="fas fa-file-invoice"></i> N√∫mero de Factura</label>
                        <input type="text" id="numeroFactura" placeholder="Ej: FAC-0001" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="clienteCompra"><i class="fas fa-user-tag"></i> Cliente</label>
                    <select id="clienteCompra" required></select>
                </div>
                <div class="actions">
                    <button type="button" onclick="guardarCompra()"><i class="fas fa-save"></i> Guardar</button>
                    <button type="button" class="warning" onclick="limpiarFormulario('compraForm')"><i class="fas fa-broom"></i> Limpiar</button>
                </div>
            </form>
            <div class="card">
                <table id="comprasTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Fecha</th>
                            <th>N¬∞ Factura</th>
                            <th>Cliente</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Tabla de Detalles -->
        <div id="detalles" class="tab-content">
            <h2><i class="fas fa-list-alt"></i> Gesti√≥n de Detalles</h2>
            <form id="detalleForm">
                <input type="hidden" id="detalleId">
                <div class="form-row">
                    <div class="form-group">
                        <label for="cantidad"><i class="fas fa-cubes"></i> Cantidad</label>
                        <input type="number" id="cantidad" placeholder="Ej: 2" required>
                    </div>
                    <div class="form-group">
                        <label for="precioUnitario"><i class="fas fa-dollar-sign"></i> Precio Unitario</label>
                        <input type="number" step="0.01" id="precioUnitario" placeholder="Ej: 5.99" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="metodoPago"><i class="fas fa-credit-card"></i> M√©todo de Pago</label>
                        <input type="text" id="metodoPago" placeholder="Ej: Tarjeta de Cr√©dito" required>
                    </div>
                    <div class="form-group">
                        <label for="compraDetalle"><i class="fas fa-shopping-cart"></i> Compra</label>
                        <select id="compraDetalle" required></select>
                    </div>
                    <div class="form-group">
                        <label for="productoDetalle"><i class="fas fa-box-open"></i> Producto</label>
                        <select id="productoDetalle" required></select>
                    </div>
                </div>
                <div class="actions">
                    <button type="button" onclick="guardarDetalle()"><i class="fas fa-save"></i> Guardar</button>
                    <button type="button" class="warning" onclick="limpiarFormulario('detalleForm')"><i class="fas fa-broom"></i> Limpiar</button>
                </div>
            </form>
            <div class="card">
                <table id="detallesTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Cantidad</th>
                            <th>Precio</th>
                            <th>M√©todo Pago</th>
                            <th>Compra</th>
                            <th>Producto</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let clientes = [];
        let productos = [];
        let compras = [];
        let detalles = [];

        // Funci√≥n para mostrar mensajes
        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = message;
            messageDiv.className = 'message ' + type;
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }

        // Funci√≥n para cambiar entre pesta√±as
        function openTab(tabName) {
            const tabs = document.getElementsByClassName('tab-content');
            for (let i = 0; i < tabs.length; i++) {
                tabs[i].classList.remove('active');
            }
            
            const tabButtons = document.getElementsByClassName('tab');
            for (let i = 0; i < tabButtons.length; i++) {
                tabButtons[i].classList.remove('active');
            }
            
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`.tab[onclick="openTab('${tabName}')"]`).classList.add('active');
            
            // Cargar datos cuando se abre la pesta√±a
            if (tabName === 'productos') cargarProductos();
            if (tabName === 'clientes') cargarClientes();
            if (tabName === 'compras') cargarCompras();
            if (tabName === 'detalles') cargarDetalles();
        }

        // Funci√≥n para limpiar formularios
        function limpiarFormulario(formId) {
            document.getElementById(formId).reset();
            if (formId === 'productoForm') document.getElementById('productoId').value = '';
            if (formId === 'clienteForm') document.getElementById('clienteRun').value = '';
            if (formId === 'compraForm') document.getElementById('compraId').value = '';
            if (formId === 'detalleForm') document.getElementById('detalleId').value = '';
        }

        // ========== PRODUCTOS ==========
        async function cargarProductos() {
            try {
                const response = await fetch('/api/productos');
                productos = await response.json();
                renderProductos();
                document.getElementById('productos-count').textContent = productos.length;
            } catch (error) {
                showMessage('Error al cargar productos: ' + error.message, 'error');
            }
        }

        function renderProductos() {
            const tbody = document.querySelector('#productosTable tbody');
            tbody.innerHTML = '';
            
            productos.forEach(producto => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${producto.idProducto}</td>
                    <td>${producto.nombreProducto}</td>
                    <td>${producto.stock}</td>
                    <td>
                        <button onclick="editarProducto(${producto.idProducto})"><i class="fas fa-edit"></i> Editar</button>
                        <button class="danger" onclick="eliminarProducto(${producto.idProducto})"><i class="fas fa-trash-alt"></i> Eliminar</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function guardarProducto() {
            const id = document.getElementById('productoId').value;
            const producto = {
                nombreProducto: document.getElementById('nombreProducto').value,
                stock: parseInt(document.getElementById('stock').value)
            };
            
            try {
                let response;
                if (id) {
                    producto.idProducto = parseInt(id);
                    response = await fetch(`/api/productos/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(producto)
                    });
                } else {
                    response = await fetch('/api/productos', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(producto)
                    });
                }
                
                if (response.ok) {
                    showMessage(`Producto ${id ? 'actualizado' : 'creado'} correctamente`, 'success');
                    limpiarFormulario('productoForm');
                    await cargarProductos();
                } else {
                    throw new Error(await response.text());
                }
            } catch (error) {
                showMessage('Error al guardar producto: ' + error.message, 'error');
            }
        }

        function editarProducto(id) {
            const producto = productos.find(p => p.idProducto === id);
            if (producto) {
                document.getElementById('productoId').value = producto.idProducto;
                document.getElementById('nombreProducto').value = producto.nombreProducto;
                document.getElementById('stock').value = producto.stock;
                document.getElementById('productos').scrollIntoView({ behavior: 'smooth' });
            }
        }

        async function eliminarProducto(id) {
            if (confirm('¬øEst√°s seguro de eliminar este producto?')) {
                try {
                    const response = await fetch(`/api/productos/${id}`, { method: 'DELETE' });
                    if (response.ok) {
                        showMessage('Producto eliminado correctamente', 'success');
                        await cargarProductos();
                    } else {
                        throw new Error(await response.text());
                    }
                } catch (error) {
                    showMessage('Error al eliminar producto: ' + error.message, 'error');
                }
            }
        }

        // ========== CLIENTES ==========
        async function cargarClientes() {
            try {
                const response = await fetch('/api/clientes');
                clientes = await response.json();
                renderClientes();
                document.getElementById('clientes-count').textContent = clientes.length;
            } catch (error) {
                showMessage('Error al cargar clientes: ' + error.message, 'error');
            }
        }

        function renderClientes() {
            const tbody = document.querySelector('#clientesTable tbody');
            tbody.innerHTML = '';
            
            clientes.forEach(cliente => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${cliente.run}</td>
                    <td>${cliente.dv}</td>
                    <td>${cliente.nombres}</td>
                    <td>${cliente.apellidos}</td>
                    <td>
                        <button onclick="editarCliente('${cliente.run}')"><i class="fas fa-edit"></i> Editar</button>
                        <button class="danger" onclick="eliminarCliente('${cliente.run}')"><i class="fas fa-trash-alt"></i> Eliminar</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function guardarCliente() {
            const run = document.getElementById('clienteRun').value;
            const cliente = {
                run: document.getElementById('run').value,
                dv: document.getElementById('dv').value,
                nombres: document.getElementById('nombres').value,
                apellidos: document.getElementById('apellidos').value
            };
            
            try {
                let response;
                if (run) {
                    response = await fetch(`/api/clientes/${run}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(cliente)
                    });
                } else {
                    response = await fetch('/api/clientes', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(cliente)
                    });
                }
                
                if (response.ok) {
                    showMessage(`Cliente ${run ? 'actualizado' : 'creado'} correctamente`, 'success');
                    limpiarFormulario('clienteForm');
                    await cargarClientes();
                } else {
                    throw new Error(await response.text());
                }
            } catch (error) {
                showMessage('Error al guardar cliente: ' + error.message, 'error');
            }
        }

        function editarCliente(run) {
            const cliente = clientes.find(c => c.run === run);
            if (cliente) {
                document.getElementById('clienteRun').value = cliente.run;
                document.getElementById('run').value = cliente.run;
                document.getElementById('dv').value = cliente.dv;
                document.getElementById('nombres').value = cliente.nombres;
                document.getElementById('apellidos').value = cliente.apellidos;
                document.getElementById('clientes').scrollIntoView({ behavior: 'smooth' });
            }
        }

        async function eliminarCliente(run) {
            if (confirm('¬øEst√°s seguro de eliminar este cliente?')) {
                try {
                    const response = await fetch(`/api/clientes/${run}`, { method: 'DELETE' });
                    if (response.ok) {
                        showMessage('Cliente eliminado correctamente', 'success');
                        await cargarClientes();
                    } else {
                        throw new Error(await response.text());
                    }
                } catch (error) {
                    showMessage('Error al eliminar cliente: ' + error.message, 'error');
                }
            }
        }

        // ========== COMPRAS ==========
        async function cargarCompras() {
            try {
                const response = await fetch('/api/compras');
                compras = await response.json();
                await cargarClientesParaSelect();
                renderCompras();
                document.getElementById('compras-count').textContent = compras.length;
            } catch (error) {
                showMessage('Error al cargar compras: ' + error.message, 'error');
            }
        }

        async function cargarClientesParaSelect() {
            try {
                const response = await fetch('/api/clientes');
                clientes = await response.json();
                
                const select = document.getElementById('clienteCompra');
                select.innerHTML = '';
                
                clientes.forEach(cliente => {
                    const option = document.createElement('option');
                    option.value = cliente.run;
                    option.textContent = `${cliente.nombres} ${cliente.apellidos} (${cliente.run})`;
                    select.appendChild(option);
                });
            } catch (error) {
                showMessage('Error al cargar clientes para select: ' + error.message, 'error');
            }
        }

        function renderCompras() {
            const tbody = document.querySelector('#comprasTable tbody');
            tbody.innerHTML = '';
            
            compras.forEach(compra => {
                const cliente = clientes.find(c => c.run === compra.cliente?.run);
                const clienteNombre = cliente ? `${cliente.nombres} ${cliente.apellidos}` : 'Desconocido';
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${compra.idCompra}</td>
                    <td>${new Date(compra.fechaCompra).toLocaleDateString()}</td>
                    <td>${compra.numeroFactura}</td>
                    <td>${clienteNombre}</td>
                    <td>
                        <button onclick="editarCompra(${compra.idCompra})"><i class="fas fa-edit"></i> Editar</button>
                        <button class="danger" onclick="eliminarCompra(${compra.idCompra})"><i class="fas fa-trash-alt"></i> Eliminar</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function guardarCompra() {
            const id = document.getElementById('compraId').value;
            const fechaCompra = document.getElementById('fechaCompra').value;
            const compra = {
                fechaCompra: fechaCompra,
                numeroFactura: document.getElementById('numeroFactura').value,
                cliente: { run: document.getElementById('clienteCompra').value }
            };
            
            try {
                let response;
                if (id) {
                    compra.idCompra = parseInt(id);
                    response = await fetch(`/api/compras/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(compra)
                    });
                } else {
                    response = await fetch('/api/compras', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(compra)
                    });
                }
                
                if (response.ok) {
                    showMessage(`Compra ${id ? 'actualizada' : 'creada'} correctamente`, 'success');
                    limpiarFormulario('compraForm');
                    await cargarCompras();
                } else {
                    throw new Error(await response.text());
                }
            } catch (error) {
                showMessage('Error al guardar compra: ' + error.message, 'error');
            }
        }

        function editarCompra(id) {
            const compra = compras.find(c => c.idCompra === id);
            if (compra) {
                document.getElementById('compraId').value = compra.idCompra;
                document.getElementById('fechaCompra').value = compra.fechaCompra.split('T')[0];
                document.getElementById('numeroFactura').value = compra.numeroFactura;
                document.getElementById('clienteCompra').value = compra.cliente.run;
                document.getElementById('compras').scrollIntoView({ behavior: 'smooth' });
            }
        }

        async function eliminarCompra(id) {
            if (confirm('¬øEst√°s seguro de eliminar esta compra?')) {
                try {
                    const response = await fetch(`/api/compras/${id}`, { method: 'DELETE' });
                    if (response.ok) {
                        showMessage('Compra eliminada correctamente', 'success');
                        await cargarCompras();
                    } else {
                        throw new Error(await response.text());
                    }
                } catch (error) {
                    showMessage('Error al eliminar compra: ' + error.message, 'error');
                }
            }
        }

        // ========== DETALLES ==========
        async function cargarDetalles() {
            try {
                const response = await fetch('/api/detalles');
                detalles = await response.json();
                await cargarComprasParaSelect();
                await cargarProductosParaSelect();
                renderDetalles();
                document.getElementById('detalles-count').textContent = detalles.length;
            } catch (error) {
                showMessage('Error al cargar detalles: ' + error.message, 'error');
            }
        }

        async function cargarComprasParaSelect() {
            try {
                const response = await fetch('/api/compras');
                compras = await response.json();
                
                const select = document.getElementById('compraDetalle');
                select.innerHTML = '';
                
                compras.forEach(compra => {
                    const option = document.createElement('option');
                    option.value = compra.idCompra;
                    option.textContent = `Compra #${compra.idCompra} (${compra.numeroFactura})`;
                    select.appendChild(option);
                });
            } catch (error) {
                showMessage('Error al cargar compras para select: ' + error.message, 'error');
            }
        }

        async function cargarProductosParaSelect() {
            try {
                const response = await fetch('/api/productos');
                productos = await response.json();
                
                const select = document.getElementById('productoDetalle');
                select.innerHTML = '';
                
                productos.forEach(producto => {
                    const option = document.createElement('option');
                    option.value = producto.idProducto;
                    option.textContent = `${producto.nombreProducto} (${producto.idProducto})`;
                    select.appendChild(option);
                });
            } catch (error) {
                showMessage('Error al cargar productos para select: ' + error.message, 'error');
            }
        }

        function renderDetalles() {
            const tbody = document.querySelector('#detallesTable tbody');
            tbody.innerHTML = '';
            
            detalles.forEach(detalle => {
                const compra = compras.find(c => c.idCompra === detalle.compra?.idCompra);
                const producto = productos.find(p => p.idProducto === detalle.producto?.idProducto);
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${detalle.idDetalle}</td>
                    <td>${detalle.cantidad}</td>
                    <td>$${detalle.precioUnitario.toFixed(2)}</td>
                    <td>${detalle.metodoPago}</td>
                    <td>${compra ? `Compra #${compra.idCompra}` : 'Desconocida'}</td>
                    <td>${producto ? producto.nombreProducto : 'Desconocido'}</td>
                    <td>
                        <button onclick="editarDetalle(${detalle.idDetalle})"><i class="fas fa-edit"></i> Editar</button>
                        <button class="danger" onclick="eliminarDetalle(${detalle.idDetalle})"><i class="fas fa-trash-alt"></i> Eliminar</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        async function guardarDetalle() {
            const id = document.getElementById('detalleId').value;
            const detalle = {
                cantidad: parseInt(document.getElementById('cantidad').value),
                precioUnitario: parseFloat(document.getElementById('precioUnitario').value),
                metodoPago: document.getElementById('metodoPago').value,
                compra: { idCompra: parseInt(document.getElementById('compraDetalle').value) },
                producto: { idProducto: parseInt(document.getElementById('productoDetalle').value) }
            };
            
            try {
                let response;
                if (id) {
                    detalle.idDetalle = parseInt(id);
                    response = await fetch(`/api/detalles/${id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(detalle)
                    });
                } else {
                    response = await fetch('/api/detalles', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(detalle)
                    });
                }
                
                if (response.ok) {
                    showMessage(`Detalle ${id ? 'actualizado' : 'creado'} correctamente`, 'success');
                    limpiarFormulario('detalleForm');
                    await cargarDetalles();
                } else {
                    throw new Error(await response.text());
                }
            } catch (error) {
                showMessage('Error al guardar detalle: ' + error.message, 'error');
            }
        }

        function editarDetalle(id) {
            const detalle = detalles.find(d => d.idDetalle === id);
            if (detalle) {
                document.getElementById('detalleId').value = detalle.idDetalle;
                document.getElementById('cantidad').value = detalle.cantidad;
                document.getElementById('precioUnitario').value = detalle.precioUnitario;
                document.getElementById('metodoPago').value = detalle.metodoPago;
                document.getElementById('compraDetalle').value = detalle.compra.idCompra;
                document.getElementById('productoDetalle').value = detalle.producto.idProducto;
                document.getElementById('detalles').scrollIntoView({ behavior: 'smooth' });
            }
        }

        async function eliminarDetalle(id) {
            if (confirm('¬øEst√°s seguro de eliminar este detalle?')) {
                try {
                    const response = await fetch(`/api/detalles/${id}`, { method: 'DELETE' });
                    if (response.ok) {
                        showMessage('Detalle eliminado correctamente', 'success');
                        await cargarDetalles();
                    } else {
                        throw new Error(await response.text());
                    }
                } catch (error) {
                    showMessage('Error al eliminar detalle: ' + error.message, 'error');
                }
            }
        }

        // Cargar datos iniciales
        document.addEventListener('DOMContentLoaded', () => {
            cargarProductos();
            cargarClientes();
            cargarCompras();
            cargarDetalles();
        });
    </script>
</body>
</html>